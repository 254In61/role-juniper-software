---
# Uploading software image to the device

# Step 1 : Download OS image from the artifacts store (gitlab in this case) and upload to device
- name: Clone the os images git artifacts
  ansible.builtin.git:
    repo: "{{ git_repo_url }}"
    dest: "{{ tmp_root_dir }}/{{ git_repo_name }}"
    version: "{{ git_repo_branch }}"
    force: yes       # Still clone down and overwrite incase local repo is existing.
  ignore_errors: true
  run_once: true
  delegate_to: localhost

- name: Set facts
  ansible.builtin.set_fact:
    sw_image_file_path: "{{ tmp_root_dir }}/{{ git_repo_name }}/{{ vendor_dir }}/{{ software_image_file_name }}"
  delegate_to: localhost

- name: "Check if {{ software_image_file_name }} exists on the local"
  ansible.builtin.stat:
    path: "{{ sw_image_file_path }}"
  register: file_check 
  delegate_to: localhost
  ignore_errors: true
    
- name: "Assert {{ software_image_file_name }} exists on the local - FAIL Playbook if NOT existing"
  ansible.builtin.assert:
    that:
      - file_check.stat.exists
    fail_msg: "{{ software_image_file_name }} does not exist on local. Playbook stopped"
    success_msg: "{{ software_image_file_name }} exists on local. Proceeding with the next tasks."
  delegate_to: localhost


# Step 2 : Upload image to the device

# - name: Check if image already existing on the device # Will it matter? Unless we worry about space?
# Added to the exec-env instead
# - name: Install junos-eznc
#   ansible.builtin.pip:
#     name: junos-eznc
#     state: present
#   delegate_to: localhost
#   ignore_errors: yes

# ISSUES HERE!
# 1, junos-eznc missing.. fixed with image rebuild.
# 2. timeout .. not a valid parameter!..Well? It is in the documentation!
# 3. host .. Needed when not missing! ..But when added, it is not a valid parameter!..Yet it is in the documentation..ghhhhhrr
# Looks like module is deprecated! https://docs.ansible.com/ansible/latest/collections/junipernetworks/junos/junos_scp_module.html#ansible-collections-junipernetworks-junos-junos-scp-module


# - name: Upload OS image to the Juniper device
#   junipernetworks.junos.junos_scp:
#     src: "{{ sw_image_file_path }}"
#     dest: "{{ juniper_device_tmp_storage }}"
#     host: "{{ inventory_hostname }}"
#     # timeout: 1800 # Is 1 hr an overkill? => Ansible complains about this, yet it is a parameter as per the documentation
#   register: upload_result

# Socket issue here
# - name: copy file from ansible controller to a network device
#   ansible.netcommon.net_put:
#     src: "{{ sw_image_file_path }}"
#     dest: "{{ juniper_device_tmp_storage }}"
#     # host: "{{ inventory_hostname }}"
#     # timeout: 1800 # Is 1 hr an overkill? => Ansible complains about this, yet it is a parameter as per the documentation
#   vars:
#     ansible_connection: ansible.netcommon.network_cli
#   register: upload_result

- name: Scp file from ansible controller to the juniper device
  ansible.buitin.shell: |
    sshpass -p '{{ ansible_password }}' scp {{ sw_image_file_path }} {{ ansible_username }}@{{ inventory_hostname }}:{{ juniper_device_tmp_storage }}
  register: upload_result

- name: Debug upload result
  ansible.builtin.debug:
    var: upload_result